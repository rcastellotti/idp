\documentclass[IN,11pt,twoside,openright,bachelor,english]{tumthesis}

\usepackage{packages}
\usepackage{IEEEtrantools}

\newcommand\toc{\relax}

\usepackage[backend=bibtex,style=ieee]{biblatex}
\usepackage{booktabs}
\usepackage{tabularx}
\usepackage{listings}

\usepackage{longtable}
\usepackage{tabu}
\usepackage{ltxtable}
\usepackage{url}
\usepackage[style=base]{caption}
\captionsetup{%
	font={rm,footnotesize},
	labelfont={sc},
}
\captionsetup[subfloat]{%
	font={rm,footnotesize},
	labelfont={rm},
}
\usepackage{subcaption}
\usepackage{nicefrac}
\usepackage{longtable}
\usepackage[hang]{footmisc}
\usepackage{blindtext}
\usepackage[printonlyused]{acronym}

\setlength\footnotemargin{5pt}

% Theorem environments
\newtheorem{definition}{Definition}
\newtheorem{theorem}{Theorem}
\newtheorem{example}{Example}
\newtheorem{lemma}{Lemma}


\usepackage{mdframed}
\newlength{\charwidth}
\setlength{\charwidth}{\widthof{\scriptsize\texttt{x}}}

\makeatletter
\newenvironment{moeplstborder}[2][]{%
\ifx#1\@empty\@empty%
	\edef\@margin{-1.5\baselineskip}%
\else%
	\edef\@margin{#1}%
\fi%
\vspace{-\baselineskip}
\begin{center}
\begin{minipage}{#2}
\begin{mdframed}[%
	topline=false,leftline=false,bottomline=false,rightline=true,
	linecolor=TUMRed!20,linewidth=\charwidth,
	innertopmargin=\@margin,innerbottommargin=-0.5\baselineskip,
	innerleftmargin=0pt,innerrightmargin=-\charwidth,
	userdefinedwidth=#2,
]%
}%
{%
\end{mdframed}%
\end{minipage}
\end{center}
}%
\makeatother


% \betreuer{Leander Seidlitz, Johannes Zirngibl}
% Needed for Bachelor's theses, Master's theses and IDP
\titleenglish{Development of a Framework for Retrieval of Parameters of the Starlink Dish}
\titlegerman{Entwurf eines Frameworks zur Informationsgewinnung von Parametern der Starlink Dish}
\author{Roberto Castellotti}
\supervisor{\chairhead}
% I am not sure what I should add here
\assistants{Dr.-Ing.~Stephan~M.~G\"unther\tlc{},%
Sebastian~GallenmÃ¼ller\tlc{}~B.\,Sc.}

% Only needed for dissertation
\chairman{\makebox[7cm]{\dotfill}}
\advisor{Prof.~Dr.-Ing.~Wolfgang~Utschick}

\courseofstudy{Electrical Engineering}

\date{September 15, 2016}

% Only for accepted disserations
%\date[November 15, 2021]{September 15, 2021} % [acceptance date]{hand-in date}

\location{Garching}

\setcounter{tocdepth}{2}

\addbibresource{bib/IEEEfull.bib}
\addbibresource{bib/litnew.bib}


%\renewcommand{\andothersdelim}{}
%bib.sty does not work older bibtex versions (works on TexLive 2016 or newer)
%\usepackage{bib}

% Load late to avoid same identifier warning
\usepackage[colorlinks=false,pdfborder={0 0 0}]{hyperref}


\begin{document}%

\bstctlcite{IEEEexample:BSTcontrol}

\pagenumbering{gobble}	
\maketitle%
\cleardoublepage


\begin{abstract} 
In this report we want to document our work and findings on Starlink based connections. 

We investigate whether Starlink-based connections result in a different routing of packets when reaching some geographically sparse targets, after that we move on analyzing whether the dish performs some buffering before relaying packets to satellite.

Lastly we analyzed satellites visible from a dish and, after developing a script to detect satellite handovers, we moved on trying to correlate  drops in bandwidth and satellite handovers.
\end{abstract}


\begin{thanks}
\end{thanks}

\tableofcontents
\listoffigures
\listoftables

\startcontent

\chapter{Satellites}
\label{chap:sats}
In this chapter we will focus on Satellites
\section{Two-line Element Sets}
Two-line Element Sets (hereinafter TLEs) are a widely used data format to encode the postion of orbital elements for a given point in time (WIKIPEDIA). This data format is ASCII based and it will allow us to understand patterns in satellite appearances and to plot the number of visible satellites at any given time. This may be a good substitute for the originally working solution, which was to make a query to retrieve the satellite the dish was connected to. Unfortunately in an earlier phase it might have been possible to call the \texttt{dish\_get\_context} or similar methods that currently either return a \texttt{PermissionDenied} error, or are deprecated.

\begin{lstlisting}[caption={TLE for satellite STARLINK-1007 },captionpos=b]
STARLINK-1007           
1 44713U 19074A   23239.65120160  .00022666  00000+0  15354-2 0  9991
2 44713  53.0553  19.2809 0001296  68.3392 291.7735 15.06406564209327
\end{lstlisting}

	
\section{Skyfield Library}

In order to work with TLEs from the Starlink constellation with Python we are using https://rhodesmill.org/skyfield/, an elegant astronomy library for Python. Retrieving TLEs for every single satellite in the LEO constellation is just a matter of running the following script:

\begin{lstlisting}[language=python,caption={retrieving a Satellite's position using the Satname},captionpos=b]
from skyfield.api import load, wgs84

stations_url = "https://celestrak.org/NORAD/elements/gp.php?GROUP=starlink&FORMAT=tle"
satellites = load.tle_file(stations_url)
print("Loaded", len(satellites), "satellites")
by_name = {sat.name: sat for sat in satellites}
satellite = by_name["STARLINK-1007"]

# year, month, day, hour, minute, second
ts = load.timescale()
t = ts.now()
a = satellite.at(t)
lat, lon = wgs84.latlon_of(a)
print("Latitude:", lat)
print("Longitude:", lon)
\end{lstlisting}

This is a very powerful mechanism, because it allows us to retrieve the satellites we might reasonably assume the dish sees at any given moment.
\subsection{Visible Satellites}
It is up to us to define what "visible" means, in our evaluations we decided that, knowing the satellites orbit around the earth at around 550 kms in height it is reasonable to assume a satellite is visible when it is above the horizon and it is (point to point) not further than 800 kms. The ground truth might be different, but this approximation allows us to approximately have an idea about what is going on in space. 

The first measurement we are setting up is the following: every 15 seconds we run a script that gets all the "visible" satellites and we store them in a SQLite database, if we saw the same satellite in the iteration before we simply update the \texttt{timestamp}, otherwise we create a new row in the db. We use a \texttt{relative\_ts} (relative timestamp) to enumerate every measurement (a probe every 15 seconds). To measure visible satellites we are running the following command: \texttt{python3 visible-satellites.py -v -lat 48.2489 -lon 11.6532 -el 0 -d 800}, where \texttt{lat} and \texttt{lon} are Garching's coordinates, we are not interested in using an elevation.


\section{Patterns in Satellites Appearances}
\section{Detecting Satellite Handovers}

\chapter{Routing}
\section{Cloud Traceroutes}
\section{Tooling}
\section{Visualizing Traceroutes}


\chapter{Exploring the gRPC api}

grcpurl
query all methods
in appendix probably? insert working methods and stuff


\section{Tooling}
\section{Getting Obstruction Maps}
Following the approach sketched in \cite{izhikevich2023democratizing} we started retrieving obstruction maps from the dish using the \texttt{dish\_get\_obstruction\_map} method exposed by the gRPC api on the dish.
cite durumeric

\begin{table}
	\centering
	\begin{tabular}{c r r}
		\toprule
		Column A & Column B & Column C \\
		\midrule
		Munich   &    1.000 &        2 \\
		Garching &  100.000 &       30 \\
		\bottomrule
	\end{tabular}
	\caption{Example of a table created with booktabs}
	\label{tab:tabular}
\end{table}


\chapter{/dev/random}

\section{Introducing some latency measurements}
\section{Does the dish buffer packets?}
mesurements with  curl --interface enp1s0f3 http://ftp.uio.no/debian-cd/12.1.0-live/amd64/iso-hybrid/debian-live-12.1.0-amd64-lxde.iso > /dev/null

\appendix
\chapter{Appendix}
\label{chap:appendix}

Remove the appendix if it is empty.

\section{Appendix section}

\begin{lstlisting}[language=python,caption={the \texttt{calculate\_visible\_satellites} function},captionpos=b]
def calculate_visible_satellites(
    observer_latitude, observer_longitude, observer_elevation, distance_km
):
    stations_url = (
        "https://celestrak.org/NORAD/elements/gp.php?GROUP=starlink&FORMAT=tle"
    )

    satellites = load.tle_file(stations_url)
    observer = Topos(observer_latitude, observer_longitude, observer_elevation)
    ts = load.timescale()
    t = ts.now()

    # Calculate satellite positions
    positions = []
    for sat in satellites:
        satellite = sat
        position = (satellite - observer).at(t)
        positions.append((sat, position))

    # Filter visible satellites
    visible_satellites = []
    for sat, position in positions:
        alt, az, distance = position.altaz()
        # Satellite is above the horizon
        if alt.degrees > 0 and distance.km < distance_km:
            visible_satellites.append((sat, alt, az))

    return visible_satellites
\end{lstlisting}

The appendix can contain different sections.

\clearpage
\pagestyle{thesischapter}

\cleardoublepage
\selectlanguage{english}
\printbibliography[heading=bibintoc]

%\cleardoublepage
\clearpage
\pagestyle{empty}
%\mbox{}
%\clearpage

\end{document}


